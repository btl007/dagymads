# Dagymads 프로젝트 계획 및 기록

이 문서는 `dagymads` 프로젝트의 비즈니스 목표, 기능 백로그, 그리고 과거의 주요 의사결정 과정을 추적하는 프로젝트 관리 허브입니다.

---

## 1. 프로젝트 목표 (Project Goals)

dagym ads SaaS

* 다짐 : (주)스톤아이 가 제공하는 헬스장 O2O 플랫폼 서비스
* 영상 : 다짐에서 헬스장 (센터) 에 '스탠다드 플랜' 이라는 마케팅 상품에 포함되는 광고 영상
* wskcrw : 영상 제작사
* 영업팀 : 다짐 부서. 헬스장 (센터)에 '라이트 플랜' 또는 '스탠다드 플랜' 마케팅 상품을 영업하는 부서
* 운영팀 : 다짐 부서. 전반적인 운영 총괄 업무. 주로 CS 업무 및 각 부서의 매개 담당
* 마케팅팀 : 다짐 부서. 영상을 컨펌, 피드백하는 업무
* 촬영팀 : wskcrw 소속. 영상 제작사. 헬스장 (센터)에 촬영과 관련된 내용을 안내하고, 광고 영상 촬영을 담당. 촬영일자를 헬스장 (센터)와 협의하는 주체. 영상의 편집을 담당. 영상의 수정을 담당.
* 개발팀 : 다짐 부서. 다짐 서비스 개발 업무 담당

* 스탠다드 플랜 프로세스
** as is
영업팀 -> 헬스장 (센터) 영업 -> 스탠다드 플랜 구좌 계약, 프로젝트 개설 -> 센터 정보 (센터명, 주소, 센터 담당자, 센터 담당자 연락처) 운영팀에 전달 -> 운영팀이 슬랙으로 촬영팀에 센터 정보 공유 -> 촬영팀이 헬스장 (센터)와 연락하여, 영상의 촬영 방식, 준비사항 안내 및 촬영일자 협의 -> 촬영팀이 헬스장 (센터) 촬영 -> 촬영팀이 영상을 촬영, 편집하여 1차본을 frame.io 링크로 운영팀 및 마케팅팀에 슬랙으로 공유 -> 마케팅팀이 수정사항을 frame.io 에 기재하여 촬영팀에게 슬랙으로 알림. -> 촬영팀이 수정사항 수정. -> 마케팅팀이 완성된 영상을 다짐 유튜브 채널에 게재 및 개발팀에게 전달 -> 개발팀이 센터의 영상과 정보를 상단 노출구좌에 작성 -> 프로젝트 종료

pain point : 다양한 부서가 통일되지 않은 채널을 통해 소통함. 유선 의존도가 높음. 헬스장 (센터)가 촬영에 필요한 멘트(대본)을 준비하지 않음. 촬영의 목적과 안내사항에 대한 전달이 어려움. 

** to be
영업팀 -> 헬스장 (센터) 영업 -> 스탠다드 플랜 구좌 계약, 프로젝트 개설 -> SaaS에 헬스장 (센터) 계정 생성 후, ID PW 제공 ((헬스장에서 만들지 않음. 만들어진걸 제공 : 이유) username을 센터명으로 하여 관리하기 위함)) -> 헬스장 (센터) 에서 dagymguide를 참고하여, 대본을 작성 (scriptEditor) -> 헬스장에서 대본 접수 -> 촬영팀이 필요에 따라 대본 첨삭 -> what time (되는시간) 서비스를 활용하여 헬스장 (센터) 촬영 가능일자 수집 (추후 개발 예정) -> 촬영팀이 해당 일자에 촬영 (필요에 따라 유선 협의) -> 촬영팀이 1차본 frame.io 링크를 센터 (프로젝트) frame.io 링크란에 작성 -> 마케팅이 해당 링크 클릭하여 frame.io 에서 피드백, Admin에서 프로젝트 상태 변경 (피드백 완료) -> 촬영팀이 필요에 따라 영상 수정 후 프로젝트 상태 변경 (수정 완료)

기대 효과 : 운영팀이 매개 역할을 하지 않아도 됨. Admin Dashboard를 통해서, 프로젝트의 전반적인 추이를 모니터링 가능함. 마케팅팀 역시 슬랙의 메세지 히스토리를 찾아다니지 않아도, 한번에 영상 프로젝트 관리 및 frame.io 접속 가능.

---

## 2. 기능 백로그 (Feature Backlog)

### Dagymads 프로젝트 아이디어 및 백로그

이 문서는 프로젝트의 향후 개발 아이디어를 관리하는 백로그입니다. 구현할 기능을 여기서 선택하고, 완료된 항목은 제거하여 관리합니다.

---

#### 1순위: 고객(센터) 경험 강화

- [ ] **고객용 '프로젝트 대시보드' 구축**
  - **내용:** 고객이 로그인 시 자신의 프로젝트 상태, 확정된 촬영일, 리뷰 링크 등을 한눈에 볼 수 있는 전용 대시보드를 제공합니다.
  - **기대 효과:** 커뮤니케이션 비용 감소 및 고객 만족도 향상.

- [ ] **알림(Notification) 시스템 도입**
  - **내용:** 프로젝트 상태 변경 시 (예: 일정 확정, 영상 업로드) 고객에게 이메일 또는 앱 내 알림을 보냅니다.
  - **기대 효과:** 업무 자동화, 고객의 중요 업데이트 누락 방지.

- [ ] **자료 업로드 기능**
  - **내용:** 고객이 로고, 브랜드 가이드, 레퍼런스 등 제작 필요 자료를 직접 업로드할 수 있는 기능을 추가합니다.
  - **기대 효과:** 자료 취합 프로세스 간소화 및 체계적인 관리.

#### 2순위: 관리자 대시보드 기능 심화

- [ ] **강력한 검색 및 필터링 기능**
  - **내용:** `AdminProject` 페이지에 센터명, 프로젝트명 검색 및 상태, 촬영일자 필터링 기능을 추가합니다.
  - **기대 효과:** 대량의 프로젝트 관리 효율성 증대.

- [ ] **통계 및 분석 대시보드 (`AdminOverview`)**
  - **내용:** `AdminOverview` 페이지에 상태별 프로젝트 개수, 월별 완료 프로젝트 수 등 핵심 지표(KPI)를 시각화합니다.
  - **기대 효과:** 데이터 기반 의사결정 지원 및 파이프라인 병목 현상 파악.

- [ ] **활동 로그 상세 연동**
  - **내용:** `ProjectInfoModal` 내부에 해당 프로젝트의 활동 로그만 필터링해서 보여주는 탭을 추가합니다.
  - **기대 효과:** 특정 프로젝트의 전체 히스토리를 한 곳에서 파악하여 컨텍스트 전환 비용 감소.

#### 3순위: 코드 품질 및 기술 부채 해소

- [ ] **데이터 페칭 로직 추상화 (`useProjects` 훅)**
  - **내용:** 반복되는 "프로젝트 조회 + 사용자 이름 조회" 로직을 `useProjects` 커스텀 훅으로 만들어 중복을 제거합니다.
  - **기대 효과:** 코드 유지보수성 향상 및 신규 페이지 개발 속도 증가.

- [ ] **권한 관리 강화 (Role-Based Access Control)**
  - **내용:** '관리자', '편집자', '고객' 등 역할(Role)을 정의하고, 역할에 따라 접근 가능한 페이지와 기능을 제어합니다.
  - **기대 효과:** 서비스 확장성을 고려한 보안 및 데이터 무결성 강화.

- [ ] **과거 데이터 일괄 마이그레이션 스크립트 작성**
  - **내용:** 약 200건의 과거 프로젝트 데이터를 CSV 파일로 정리한 뒤, 이를 읽어 Supabase DB에 일괄 삽입(Bulk Insert)하는 Node.js 스크립트를 작성합니다.
  - **기대 효과:** 수동 입력으로 인한 시간 낭비와 인적 오류(Human Error)를 방지하고, 빠르고 정확하게 초기 데이터를 시스템에 통합합니다.


---

## 3. 개발 로그 및 히스토리 (Development Log & History)

### Slot 기반 스케쥴 관련 (초기 기획)
# 스케줄링 시스템 (`what_time`) 기술 명세서

## 1. 개요 (Overview)

이 문서는 '다짐 광고' SaaS의 촬영일 스케줄링 기능 구현을 위한 기술 명세를 정의합니다.

본 시스템은 **'미리 생성된 슬롯 (Pre-generated Slot)'** 모델을 기반으로 합니다. 이 모델은 구현의 단순성과 명확성에 중점을 두어, 개발 속도를 높이고 안정성을 확보하는 것을 목표로 합니다.

- **핵심 개념:** 1시간 단위의 모든 시간 슬롯을 데이터베이스에 미리 생성해두고, 각 슬롯의 상태를 변경하며 사용자와 관리자가 소통합니다.
- **시간 정책:** 시스템의 모든 시간 데이터는 애플리케이션 레벨에서 **한국 표준시(KST)를 기준**으로 처리합니다.

### 1.1. 아키텍처 결정 (Architectural Decision)

초기에는 클라이언트에서 Supabase Edge Function (`functions.invoke`)을 호출하는 방식을 고려했으나, `SupabaseProvider`를 통한 인증 토큰 자동 주입이 일관되게 동작하지 않아 고질적인 401 Unauthorized 오류가 발생했습니다.

이를 해결하기 위해, 클라이언트에서 호출하는 모든 백엔드 로직은 **데이터베이스 SQL RPC 함수**로 구현하고, 클라이언트에서는 `supabase.rpc()`를 통해 호출하는 것으로 아키텍처를 변경했습니다. 이 방식은 `supabase.from().select()`와 동일한 인증 경로를 사용하므로 인증이 안정적으로 동작하는 것이 확인되었습니다.

---

## 2. 데이터 모델 (Data Model)

### 2.1. `time_slots` 테이블 (신규 생성)

시스템의 중심이 되는 테이블로, 모든 시간 슬롯의 정보와 상태를 관리합니다.

| 컬럼명 | 타입 | 필수 | 설명 |
| :--- | :--- | :--- | :--- |
| `id` | `bigint` (PK) | O | 고유 식별자 (Auto-increment) |
| `slot_time` | `timestampz` | O | 슬롯의 시작 시간 (타임존 포함, 예: `2025-10-23 14:00:00+09`) |
| `is_open` | `boolean` | O | **관리자가 오픈한 시간인지 여부.** `false`이면 어떤 사용자도 선택할 수 없음. (기본값: `true`) |
| `booking_status` | `text` | O | **슬롯의 예약 상태.** (기본값: `'available'`)<br>- `available`: 예약 가능<br>- `requested`: 센터가 예약 요청<br>- `confirmed`: 관리자가 예약 확정 |
| `project_id` | `uuid` (FK) | X | 이 슬롯을 점유(요청/확정)한 프로젝트의 ID. `projects.id`와 연결. |

### 2.2. 관련 테이블 (기존 테이블 활용)

- **`projects` 테이블:**
    - `shootdate` (`date`): 관리자가 특정 슬롯을 `confirmed` 상태로 변경할 때, 해당 슬롯의 날짜(`slot_time`)가 이 컬럼에 최종적으로 기록됩니다.
    - `status` (`text`): 스케줄링 워크플로우에 따라 상태가 변경됩니다. (예: `script_submitted` -> `schedule_requested` -> `schedule_confirmed`)

- **`user_profiles` 테이블:**
    - 역할(Role)은 Clerk JWT의 `public_metadata`에 포함된 `is_admin` (boolean) 값을 통해 관리됩니다. `is_admin`이 `true`가 아니면 모두 `center`로 간주하며, 이는 Supabase RLS(Row Level Security) 정책에 의해 제어됩니다. 별도의 `role` 컬럼은 사용하지 않습니다.

### 2.3. 테이블 관계 (Table Relationships)

- `time_slots.project_id`는 `projects.id`를 참조합니다. (One-to-Many: 하나의 프로젝트가 여러 개의 시간 슬롯을 `requested` 상태로 가질 수 있음)

---

## 3. 핵심 RPC 함수 및 로직 (Core RPC Functions & Logic)

모든 백엔드 로직은 클라이언트에서 `supabase.rpc()`로 호출되는 아래의 SQL 함수들로 구현됩니다.

#### `generate_slots_for_date(date)`
- **역할:** SQL 전용 헬퍼 함수.
- **설명:** 특정 날짜에 대한 24개의 시간 슬롯을 `time_slots` 테이블에 생성합니다. `manual_generate_slots` RPC를 통해 간접적으로 호출됩니다.

#### `manual_generate_slots(p_target_date)`
- **역할:** 관리자용 RPC.
- **설명:** 관리자가 수동으로 특정 날짜의 슬롯을 생성합니다. 내부적으로 관리자 권한을 확인합니다.

#### `get_all_slots(p_start_date, p_end_date)`
- **역할:** 관리자용 RPC.
- **설명:** 관리자가 특정 기간의 모든 슬롯 정보를 조회합니다. 내부적으로 관리자 권한을 확인합니다.

#### `request_schedule_slots(p_project_id, p_slot_ids, p_user_id)`
- **역할:** 클라이언트(센터)용 RPC.
- **설명:** 사용자가 원하는 시간 슬롯 예약을 요청합니다. 내부적으로 프로젝트 소유권을 확인하며, 여러 데이터 업데이트를 트랜잭션으로 처리합니다.

#### `confirm_schedule_slot(p_project_id, p_confirmed_slot_id)`
- **역할:** 관리자용 RPC.
- **설명:** 관리자가 사용자가 요청한 슬롯 중 하나를 최종 촬영일로 확정합니다. 관련 데이터 업데이트를 트랜잭션으로 처리합니다.

#### `update_slot_availability(p_slot_ids, p_is_open)`
- **역할:** 관리자용 RPC.
- **설명:** 관리자가 특정 시간 슬롯들의 예약 가능 여부(`is_open`)를 일괄 변경합니다. 내부적으로 관리자 권한 및 슬롯 상태를 확인하여 안전하게 처리합니다.


### 과거 스프린트 기록
## Completed Sprints

### Sprint 2: 마이페이지 및 에디터 통합 (2025년 9월 4일 완료)

**목표:** 사용자 '마이페이지'를 구현하여 대본을 조회, 편집, 삭제하고, 에디터의 안정적인 로딩을 보장합니다.

**구현된 주요 기능:**

*   **마이페이지 오버레이 (`MyScript.jsx`):
    *   에디터 우측에 토글 가능한 오버레이 패널로 구현.
    *   사용자 대본 목록 조회 및 표시 (제목, 한 줄 미리보기, 최종 수정 시간).
    *   대본 삭제 기능 추가 (확인 알림 포함).
*   **에디터 (scriptEditor.jsx) 기능 개선:**
    *   **URL 기반 대본 로딩:** `/editor` (새 글) 또는 `/editor/스크립트ID` (기존 글 수정) 경로에 따라 대본을 정확히 로드.
    *   **저장되지 않은 변경사항 경고:** 에디터 내용 수정 후 저장하지 않고 앱 내부에서 다른 페이지로 이동 시 경고창 표시.
    *   **좌측 예시 대본 목록 기능 복원:** 클릭 시 에디터에 내용 삽입 기능 복구.
*   **핵심 버그 해결 및 아키텍처 개선:**
    *   **Supabase RLS `uuid` 오류 최종 해결:**
        *   **원인:** Supabase의 `auth.jwt() ->> 'sub'` 클레임이 `uuid` 타입으로 잘못 해석되는 내부적인 '마법' 같은 동작 때문이었음.
        *   **해결:** Clerk JWT 템플릿에 `user_id: "{{user.id}}"` 커스텀 클레임을 추가하고, RLS 정책을 `auth.jwt() ->> 'user_id'` 기반으로 수정하여 `TEXT` 타입 비교를 강제함.
    *   **에디터 로딩/렌더링 문제 해결:**
        *   **원인:** `useEffect` 내에서 `editorInstance`를 기다리면서 로딩 화면이 에디터 렌더링을 막는 '닭-달걀' 문제 발생.
        *   **해결:** `Editor.jsx`에 `onReady` 콜백을 복원하고, `scriptEditor.jsx`에서 `editorInstance.setEditorState()`를 사용하여 에디터 내용을 명령적으로 업데이트하는 방식으로 전환. 로딩 오버레이는 에디터 렌더링을 막지 않도록 수정.
    *   **Clerk `<SignedIn>` 충돌:** `react-router-dom`의 동적 파라미터와 `<SignedIn>` 컴포넌트 간의 충돌 확인. 임시적으로 `<SignedIn>` 래퍼를 제거하여 해결 (보안은 RLS에 위임).
    *   **`updated_at` 컬럼 누락:** 누락된 `updated_at` 컬럼 및 자동 업데이트 트리거 추가.

**결과:**

*   핵심 대본 관리 기능 (생성, 목록 조회, 편집, 삭제)이 이제 완벽하게 작동하고 안정적입니다.
*   사용자 경험을 개선하는 '저장되지 않은 변경사항' 경고 기능이 추가되었습니다.
*   복잡했던 에디터 초기화 및 데이터 연동 문제가 해결되어, 향후 기능 확장의 기반이 마련되었습니다.


### Sprint 3: 어드민 대쉬보드 및 대본 접수 기능 구현 (2025년 9월 6일 완료)

**목표:** 사용자가 작성한 대본을 '접수' 하면, 어드민 대쉬보드에서 대본의 내용을 확인할 수 있습니다.

**구현된 주요 기능:**

*   **어드민 대쉬보드:**
    *   **접근 제어:** `is_admin: "true"`인 사용자만 어드민 대쉬보드 접속 가능. (✅ 완료)
    *   **대본 조회 (컬럼 뷰):**
        *   `status != 'draft'`인 모든 대본을 조회 (사용자별 그룹화).
        *   사용자 ID 대신 Clerk에서 가져온 사용자 이름(username) 표시.
        *   대본 제목, 상태, 최종 수정일, 접수일로부터 경과 일수(D+NNN일) 표시.
        *   대본 내용 미리보기.
    *   **대본 상태 변경:** 'submitted', 'under_review', 'approved' 상태로 변경하는 버튼 구현.
*   **대본 접수 기능:**
    *   `scriptEditor.jsx`에 '접수' 버튼 추가.
    *   Supabase `scripts` 테이블에 `status` 및 `submitted_at` 컬럼 추가 및 업데이트.
    *   대본은 제출 후에도 수정 가능 (스냅샷 개념).
    *   '내 대본' 목록에 대본 상태 표시.
*   **어드민의 사용자 추가 기능:**
    *   `AddUserForm.jsx`를 통해 어드민이 새로운 사용자를 생성하는 기능 구현.
    *   Clerk API와 연동하여 사용자 계정 생성.
    *   보안에 취약한 비밀번호 사용 시, 명확한 에러 메시지를 표시하도록 UX 개선.

### Sprint 4: 프로젝트 관리 시스템 도입 및 UI/UX 개편 (2025년 9월 6일 완료)

**목표:** 단순 대본 관리 시스템에서, 영상 제작 프로세스 전반을 관리하는 SaaS의 기반을 마련하고 전체적인 사용자 경험을 개선합니다.

**구현된 주요 기능:**

*   **핵심 아키텍처 재설계:**
    *   **'프로젝트' 개념 도입:** 기존의 '대본' 중심에서, '센터'별 영상 제작 과정을 나타내는 '프로젝트' 중심으로 관리 단위를 변경.
    *   **데이터베이스 스키마 확장:**
        *   `projects` 테이블을 신규 생성하여 프로젝트의 상태, frame.io 링크 등을 관리.
        *   `scripts` 테이블에 `project_id`를 추가하여 프로젝트와 대본의 1:N 관계를 정립.
        *   `forSupabase.md` 가이드라인에 따라 `user_id`는 `TEXT`로, 테이블의 고유 ID는 `UUID`로 타입을 명확히 구분하여 설계.
    *   **백엔드 로직 자동화:**
        *   관리자가 신규 센터(사용자)를 생성하면, 해당 센터의 첫 번째 프로젝트가 `projects` 테이블에 자동으로 생성되도록 `create-clerk-user` Edge Function을 수정.
        *   프로젝트 생성 실패 시, 방금 만든 Clerk 유저를 다시 삭제하는 롤백 로직을 추가하여 데이터 정합성을 보장.

*   **어드민 대시보드 리팩토링:**
    *   **프로젝트 칸반 보드 도입:** 관리자가 전체 프로젝트의 진행 상황(`대본 필요`, `대본 접수`, `영상 초안` 등)을 한눈에 파악할 수 있는 칸반 보드를 구현.
    *   **기존 상세 뷰 유지:** 칸반 보드 하단에 기존의 3단 컬럼 뷰(센터 목록 -> 대본 목록 -> 대본 상세)를 유지하여, 상세 조회 및 아카이빙 목적으로 활용할 수 있도록 함.
    *   두 가지 뷰(칸반, 컬럼)에 필요한 데이터를 효율적으로 불러오고 관리하도록 데이터 로직을 통합.

*   **UI/UX 대규모 개선:**
    *   **스크립트 에디터 레이아웃 개편:** 좌측 '예시 대본'과 우측 '내 대본' 패널을 모두 동적으로 열고 닫을 수 있는 유연한 3단 레이아웃으로 전면 수정. `framer-motion`을 이용한 부드러운 애니메이션을 적용.
    *   **디자인 시스템 통일:** 앱 전반에 걸쳐 일관된 다크 모드 테마를 적용. `UserProfile`, `AdminDashboard`, `MyScript` 등 핵심 페이지들의 UI를 재정비하여 통일성을 확보.
    *   **컴포넌트 개선:** `MyScript` 목록을 정보 가독성이 높은 카드 형태로 변경하고, 대본 상태를 색상 뱃지로 표시하여 직관성을 높임.

*   **주요 버그 수정:**
    *   `user_profiles` 테이블의 `updated_at` 컬럼 누락 문제 해결.
    *   컴포넌트 리팩토링 과정에서 발생한 다수의 `ReferenceError` 및 중복 `export` 오류 수정.

### Sprint 5: 데이터 모델 및 관리자 UI 정교화 (2025년 9월 12일 완료)

**목표:** 사용자 경험을 개선하기 위해 데이터 흐름을 유기적으로 만들고, 관리자 대시보드의 사용성을 높이며, 치명적인 인증 및 데이터 로딩 버그를 해결합니다.

**구현된 주요 기능:**

*   **데이터 모델 정교화 (프로젝트-스크립트 연동):**
    *   **문제 인식:** `Project`와 `Script`가 `User`에만 각각 연결되어 있어, 스크립트 제출 시 어떤 프로젝트의 상태를 변경해야 할지 모호한 문제 발견.
    *   **해결:** `scripts` 테이블에 `project_id` 컬럼을 추가하여 `Project -> Script`의 명확한 부모-자식 관계를 정립.
    *   **사용자 경험(UX) 개선:** 사용자가 스크립트 저장 시, 시스템이 자동으로 해당 사용자의 가장 최근 프로젝트를 찾아 연결해주는 로직을 구현. 이를 통해 사용자는 프로젝트를 수동으로 선택할 필요가 없어짐.

*   **프로젝트 라이프사이클 자동화:**
    *   사용자가 '대본 접수' 버튼을 누르면, 해당 스크립트가 소속된 프로젝트의 상태가 `script_needed`에서 `script_submitted`로 자동 변경되는 로직을 구현.
    *   데이터베이스에 저장되는 상태(status) 값을 `대본 필요` (한글)에서 `script_needed` (영문)와 같이 표준화하여 데이터 일관성을 확보.

*   **관리자 대시보드 UI/UX 개선:**
    *   **칸반 카드 정보 개선:** 프로젝트 카드의 UI를 개편하여 센터명(username), 프로젝트명, 생성 연월, 경과일을 명확히 표시.
    *   **상세 조회 뷰 개편:** 기존 3단 구조를 **[전체 센터] - [센터 정보] - [접수된 대본] - [대본 내용]** 의 4단 구조로 확장하여 정보 탐색의 편의성을 증대.
    *   **칸반-상세조회 연동:** 칸반 카드에서 센터명을 클릭하면, 하단의 상세 조회 뷰가 해당 센터의 정보로 즉시 업데이트되는 동적 기능을 추가.

*   **치명적 버그 수정:**
    *   **JWT expired (토큰 만료) 오류:** `SupabaseProvider`가 앱 로딩 시 한 번만 토큰을 설정하던 문제를 해결. 이제 모든 API 요청마다 새로운 인증 토큰을 동적으로 받아 사용하도록 수정하여, 토큰 만료로 인한 인증 오류를 원천적으로 차단.
    *   **`get-all-clerk-users` 엣지 함수 오류:** CORS 정책, HTTP 메소드 불일치, Clerk SDK의 응답 데이터 구조 해석 오류 등 복합적인 문제를 단계적으로 디버깅하여 해결. 이제 관리자 UI에 필요한 모든 사용자의 `username`을 안정적으로 불러올 수 있음.

### Sprint 6: 관리자 대시보드 리팩토링 및 기능 확장 (2025년 9월 13일 완료)

**목표:** `shadcn/ui`를 도입하여 관리자 대시보드의 UI를 현대화하고, 중첩 라우팅을 적용하여 코드 구조를 개선하며, 새로운 관리 기능을 추가합니다.

**구현된 주요 기능:**

*   **`shadcn/ui` 도입 및 UI 시스템 구축:**
    *   `shadcn/ui` 라이브러리를 프로젝트에 설치하고, `jsconfig.json` 설정 및 의존성 문제를 해결하여 안정적인 개발 환경을 구축.
    *   `Table`, `Badge`, `ResizablePanel` 등 다양한 `shadcn` 컴포넌트를 활용하여 UI를 체계적으로 구성.
    *   `sidebar-01` 블록을 도입하여 전문적인 대시보드 사이드바 레이아웃을 빠르게 구현하고, 프로젝트에 맞게 커스터마이징.
    *   앱 전체에 다크 모드를 기본으로 적용하여 일관된 디자인을 유지.

*   **대시보드 아키텍처 리팩토링 (중첩 라우팅):**
    *   기존의 단일 거대 컴포넌트였던 `AdminDashboard`를 `AdminLayout`과 여러 페이지 컴포넌트로 분리.
    *   React Router의 `<Outlet />`을 사용한 중첩 라우팅 구조를 도입하여, 사이드바 레이아웃은 유지한 채 내부 컨텐츠만 교체하는 현대적인 SPA 아키텍처를 적용.
    *   `AdminOverview`, `AdminKanban`, `AdminScript`, `AdminUsers`, `AdminProject` 등 기능별로 페이지를 분리하여 코드의 모듈성과 확장성을 크게 향상.

*   **신규 관리 기능 추가:**
    *   **전체 프로젝트 조회 (`AdminProject.jsx`):** 모든 프로젝트의 상세 정보(프로젝트명, 센터명, 담당자명, 상태 등)를 한눈에 볼 수 있는 테이블 형태의 조회 기능을 구현.

*   **백엔드 스키마 확장:**
    *   `user_profiles` 테이블에 `address` (주소) 컬럼을 추가.
    *   `projects` 테이블에 `shootdate` (촬영일) 컬럼을 추가하여 향후 기능 확장을 위한 기반을 마련.

### Sprint 7: 촬영일 관리 캘린더 구현 및 리팩토링 (2025년 9월 14일 완료)

**목표:** 관리자가 프로젝트별 촬영 일정을 시각적으로 확인하고, 손쉽게 변경할 수 있는 캘린더 기능을 구현하며, 코드의 재사용성을 높입니다.

**구현된 주요 기능:**

*   **촬영일 관리 페이지 (`AdminVideo.jsx`):**
    *   프로젝트의 `shootdate`를 기반으로 날짜에 점을 찍어주는 캘린더를 구현.
    *   캘린더의 특정 날짜를 클릭하면, 해당일에 촬영이 예정된 프로젝트 목록이 우측에 표시됨.
    *   우측 목록의 프로젝트를 클릭하면, 촬영일을 변경할 수 있는 모달(`Dialog`)이 열림.
    *   모달 안의 캘린더에서 새로운 날짜를 선택하고 저장하면, 데이터베이스가 업데이트되고 UI가 자동으로 새로고침됨.
    *   날짜 변경 성공 시, "일정이 정상적으로 변경되었습니다." 라는 확인 알림(`Toast`)을 표시하여 사용자 경험을 개선.

*   **컴포넌트 리팩토링:**
    *   기존의 캘린더 로직을 분리하여, 특정 날짜 배열(`highlightedDates`)을 받아 점을 찍어주는 범용적인 `CustomCalendar.jsx` 컴포넌트를 생성.
    *   이를 통해 향후 다른 종류의 일정을 표시해야 할 때도 컴포넌트를 쉽게 재사용할 수 있는 기반을 마련.

*   **핵심 버그 해결:**
    *   **`useSupabase` 컨텍스트 오류:** `AdminVideo.jsx` 페이지에서만 Supabase 클라이언트 객체를 받아오지 못하는(`undefined`) 치명적인 문제를 발견.
    *   **원인:** `useSupabase()` 훅을 `const { supabase } = useSupabase()`로 잘못 사용하고 있었음. (올바른 사용법: `const supabase = useSupabase()`)
    *   **해결:** 올바른 훅 사용법으로 수정하여, 페이지의 모든 데이터 조회 기능(캘린더 점 표시, 날짜 클릭 시 상세 정보 표시)을 정상화함.

### Sprint 8: 통합 로그 시스템 구축 및 Admin UI 고도화 (2025년 12월 8일 완료)

**목표:** 데이터 변경 사항을 전방위적으로 추적하는 통합 로그 시스템을 구축하고, Admin 페이지들의 UI/UX를 전문가 수준으로 고도화합니다.

**구현된 주요 기능:**

*   **통합 로그 시스템 (`audit_logs`):**
    *   `project_activity_logs`를 대체하는 범용 `audit_logs` 테이블을 신설했습니다.
    *   **DB 트리거 적용:** `projects`, `user_profiles`, `time_slots` 등 주요 테이블의 `INSERT`, `UPDATE`, `DELETE` 발생 시 자동으로 로그를 남기는 PostgreSQL 트리거 함수를 구현했습니다.
    *   **노이즈 필터링:** `time_slots` 자동 생성(대량 INSERT)과 같이 운영상 중요하지 않은 로그는 기록되지 않도록 트리거 로직을 최적화했습니다.
    *   **Edge Function 연동:** `reset-clerk-user-password` 함수에서 비밀번호 초기화 성공 시 `audit_logs`에 직접 로그를 남기도록 하여, DB 트리거로 잡을 수 없는 액션까지 추적 범위를 넓혔습니다.

*   **AdminLog 페이지 리팩토링:**
    *   **스마트 로그 뷰어:** 복잡한 JSON 로그 데이터를 "누가, 무엇을, 어떻게 변경했는지" 알 수 있는 문장형(Human-readable) UI로 변환하여 표시합니다.
    *   **데이터 시각화:** 변경 전/후 값을 화살표와 색상(취소선/초록색)으로 구분하여 직관적으로 보여줍니다.
    *   **정보 매핑:** `target_id`만 보여주는 대신, `projects`, `user_profiles`, `time_slots` 테이블을 추가 조회하여 실제 프로젝트명, 센터명, 시간 슬롯(날짜/시간)을 표시합니다.

*   **비밀번호 초기화 기능:**
    *   `AdminUsers` 페이지의 수정 모달에 '비밀번호 초기화' 버튼을 추가했습니다.
    *   **보안 강화:** Edge Function에서 JWT Payload를 검증하여 관리자(`is_admin`) 권한을 엄격하게 확인한 후 Clerk API를 호출하도록 구현했습니다.

*   **Admin UI/UX 전면 개편:**
    *   **AdminUsers:** 단순 리스트를 `shadcn/ui` Table로 교체하고, 검색(필터링) 기능을 추가하여 데이터 관리 효율성을 높였습니다.
    *   **AdminProject:** 검색 기능을 추가하고, 센터 정보 수정 시 `user_profiles` 테이블까지 함께 업데이트되도록 데이터 저장 로직을 수정했습니다.
    *   **AdminVideo:** `UserScheduleModal`을 개량한 `AdminSchedulePickerModal`을 도입하여, 관리자가 날짜뿐만 아니라 구체적인 시간 슬롯까지 지정하여 촬영을 확정할 수 있도록 개선했습니다. 레이아웃을 `AdminSchedule`과 통일하여 일관성을 확보했습니다.

*   **향후 계획 (AdminOverview 개편):**
    *   단순 리스트 나열 방식을 탈피하고, 핵심 지표(KPI) 카드, 차트, 최근 활동 로그 등을 한눈에 볼 수 있는 **SaaS형 대시보드**로 전면 개편할 예정입니다.


AdminOverview 개편 제안 (SaaS Dashboard Style)

  1. 상단: 핵심 지표 (KPI Cards)
  숫자로 현재 상태를 요약합니다. 클릭하면 해당 페이지로 이동합니다.
   * 전체 프로젝트: 진행 중인 모든 프로젝트 수.
   * 대본 대기: script_needed 상태인 프로젝트 수 (가장 시급한 업무).
   * 촬영 예정: 이번 달 예정된 촬영 건수.
   * 편집 중: 촬영은 끝났지만 아직 완료되지 않은 프로젝트 수.

  2. 중단: 시각화 및 빠른 접근
   * 좌측 (진행 현황): 파이 차트나 바 차트로 프로젝트 상태 분포(대본 필요 vs 촬영
     대기 vs 편집 중 등)를 보여줍니다. (Recharts 라이브러리 활용 추천)
   * 우측 (빠른 실행): 새 프로젝트 생성, 새 사용자 추가 등 자주 쓰는 기능을
     버튼으로 배치합니다.

  3. 하단: 최근 활동 및 임박한 일정
   * 좌측 (최근 활동 로그): 방금 만든 audit_logs의 최신 5~10개를 간략하게
     보여줍니다. (누가 무엇을 했는지 바로 파악)
   * 우측 (다가오는 촬영): 오늘/내일/이번 주 촬영 일정이 잡힌 프로젝트 리스트.

  ---

  구현 단계

   1. 데이터 준비: projects, audit_logs, time_slots 테이블에서 필요한 데이터를 한
      번에 가져오는 쿼리 작성 (또는 각각 병렬 호출).
   2. 레이아웃 잡기: Grid 시스템을 활용하여 2열 또는 3열 구조 배치.
   3. 컴포넌트 구현:
       * StatCard: 아이콘, 숫자, 라벨이 있는 카드.
       * RecentLogs: AdminLog의 축소판.
       * UpcomingShoots: 날짜순 정렬된 리스트.